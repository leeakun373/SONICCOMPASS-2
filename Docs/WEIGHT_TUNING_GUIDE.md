# 权重调优指南 (Weight Tuning Guide)

## 问题描述

**现象**: 即使使用了超级锚点策略（向量注入），仍有子类离开大类的集中范围。

**示例**: 
- ANMLMisc (杂项动物) 下的 Asian Palm Civet (果子狸) 在坐标 (7.07, -14.91)
- ANMLWcat (野生猫科) 下的 Lion (狮子) 在坐标 (6.84, -14.97)
- ANMLMisc 下的 Camel (骆驼) 在坐标 (6.51, -16.27)

虽然它们都属于 ANIMALS 大类，但坐标分散，没有形成紧密的大陆。

## 调优策略

### 1. 逐步提升 category_weight

**当前配置**:
- `CATEGORY_WEIGHT = 75.0` (从 50.0 提升)
- `CATEGORY_WEIGHT_SMALL = 50.0` (小数据集)
- `CATEGORY_WEIGHT_LARGE = 75.0` (大数据集)

**测试建议**:

| 权重值 | 预期效果 | 副作用风险 | 建议 |
|--------|---------|-----------|------|
| 50.0 | 已有基础聚合 | 仍有子类分离 | ✅ 当前基线 |
| **75.0** | **更强聚合** | **轻微重叠** | **🎯 当前测试值** |
| 100.0 | 很强聚合 | 可能过度紧密 | 📊 下一步测试 |
| 150.0 | 极端聚合 | 失去内部结构 | ⚠️ 极端情况 |

### 2. 配合调整 min_dist

**原理**: `category_weight` 越高，点越紧密，需要适当增大 `min_dist` 防止过度重叠。

**当前配置**:
- `MIN_DIST = 0.05` (从 0.01 调整)

**调整建议**:

| category_weight | 推荐 min_dist | 说明 |
|----------------|--------------|------|
| 50.0 | 0.01 - 0.05 | 紧密聚类 |
| **75.0** | **0.05 - 0.1** | **当前测试值** |
| 100.0 | 0.1 - 0.2 | 防止过度重叠 |
| 150.0 | 0.2 - 0.3 | 提供呼吸空间 |

### 3. 测试流程

#### 步骤 1: 修改配置
编辑 `core/umap_config.py`:
```python
CATEGORY_WEIGHT = 75.0  # 或 100.0, 150.0
MIN_DIST = 0.05         # 相应调整
```

#### 步骤 2: 运行测试
```bash
# 全库测试（推荐）
python tools/verify_subset.py --all --limit 1000

# 或针对特定类别
python tools/verify_subset.py ANIMALS --limit 500
```

#### 步骤 3: 分析结果
查看生成的CSV文件 (`verify_output/verify_ALL_details_*.csv`)，检查：
- 同一主类别的数据是否聚集在一起
- 子类（如 ANMLMisc 的 Asian Palm Civet）是否回到大类范围
- 点是否过度重叠（需要调整 min_dist）

#### 步骤 4: 对比分析（可选）
使用对比工具：
```bash
python tools/test_weight_progression.py \
    verify_output/verify_ALL_details_01101515.csv \
    verify_output/verify_ALL_details_01101900.csv \
    ANIMALS
```

## 关键指标

### 1. 聚类紧密度
- **平均距离（到类别中心）**: 越小越好
- **最大距离（到类别中心）**: 越小越好，说明没有"叛逃"的子类
- **扩散度（标准差）**: 越小越好，说明聚类越紧密

### 2. 子类分离检查
在CSV文件中搜索特定子类，检查它们的坐标：
- 是否与同类其他子类聚集？
- 是否离开主类别的中心区域？

### 3. 重叠检查
- 可视化图中点是否清晰可辨？
- 如果点都重叠在一起，需要增大 `min_dist`

## 注意事项

### ⚠️ 权重过高的风险

1. **失去内部结构**: 
   - 如果 `category_weight` 太高（如 150.0），同一大类下的所有点可能完全重叠
   - 无法区分子类（狮子 vs 骆驼）

2. **过度紧密**:
   - 所有点挤在一起，可视化效果差
   - 需要通过 `min_dist` 调整

3. **计算效率**:
   - 权重越高，向量维度越大（1024 + 类别数）
   - 可能影响计算速度（但影响很小）

### ✅ 平衡点建议

**推荐配置**:
- `CATEGORY_WEIGHT = 75.0 - 100.0` (根据测试结果选择)
- `MIN_DIST = 0.05 - 0.1` (配合权重调整)
- `SPREAD = 1.0` (保持当前值)

## 测试计划

### 阶段 1: 基线测试 (已完成)
- `CATEGORY_WEIGHT = 50.0`
- 结果：仍有子类分离

### 阶段 2: 强化测试 (当前)
- `CATEGORY_WEIGHT = 75.0`
- `MIN_DIST = 0.05`
- 目标：观察子类是否回到大类范围

### 阶段 3: 进一步强化 (如果阶段2不够)
- `CATEGORY_WEIGHT = 100.0`
- `MIN_DIST = 0.1`
- 目标：强制聚合所有子类

### 阶段 4: 极端测试 (如果阶段3不够)
- `CATEGORY_WEIGHT = 150.0`
- `MIN_DIST = 0.2`
- 目标：极端聚合（可能失去内部结构）

## 预期效果

### 成功标准
- ✅ 同一主类别的所有子类都在一个紧密的区域内
- ✅ 最大距离（到类别中心）< 5.0（相对于当前 ~15.0）
- ✅ 没有子类"叛逃"到其他大类区域

### 失败标准
- ❌ 子类仍然分散
- ❌ 可视化图中点完全重叠（需要增大 min_dist）
- ❌ 无法区分子类（需要降低权重）

## 参考数据

### 当前数据（category_weight=50.0）
- ANIMALS 类别：扩散度较大，有子类分离
- Asian Palm Civet: (7.07, -14.91) - 距离 ANIMALS 中心较远
- Lion: (6.84, -14.97) - 与果子狸接近但应该在更大的 ANIMALS 集群中
- Camel: (6.51, -16.27) - 也在不同位置

### 目标数据（category_weight=75.0+）
- ANIMALS 类别：所有子类形成一个紧密的集群
- 最大距离 < 5.0
- 子类之间仍可区分，但在同一区域内
